{% layout none %}

<script async type="text/javascript" src="https://static.klaviyo.com/onsite/js/klaviyo.js?company_id=VwWUpX"></script>

<style>
    .klaviyo-close-form{
      display:none !important;
    }


  /* .klaviyo-form {
    position: relative !important;
  }

  .klaviyo-form::after {
    content: '' !important;
    position: absolute !important;
    inset: 0 !important;
    background: linear-gradient(
                0deg,
                rgba(0,0,0,.50) 0%,
                rgba(0,0,0,.50) 100%
              ) !important;
    pointer-events: none !important;
    z-index: 1 !important;
  } */
  .klaviyo-form > div:first-child {
    z-index:5;
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(85px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    height: 100%;
    align-self: center;
    border-radius: 12px;
    padding: 2rem !important;
  }
</style>
{% if customer %}
  <script>
    window.loggedInCustomerEmail = "{{ customer.email | escape }}";
  </script>
{% else %}
  <script>
    window.loggedInCustomerEmail = null;
  </script>
{% endif %}
<script>
  (function () {
    // Prevent double initialization
    if (window.preCheckoutTrackingInitialized) return;
    window.preCheckoutTrackingInitialized = true;

    window._klOnsite = window._klOnsite || [];
    window._klOnsite.push(['openForm', 'XTF6id']);

    document.addEventListener('DOMContentLoaded', function () {
      let formSubmitted = false;

      function waitForForm(selector, callback, timeout = 5000) {
        const startTime = Date.now();
        const interval = setInterval(() => {
          const form = document.querySelector(selector);
          if (form) {
            clearInterval(interval);
            callback(form);
          } else if (Date.now() - startTime > timeout) {
            clearInterval(interval);
            console.warn('Klaviyo form not found:', selector);
          }
        }, 100);
      }

      waitForForm('[data-testid="klaviyo-form-XTF6id"]', function(form) {
        form.addEventListener('submit', function () {
          formSubmitted = true;
        });
      });

      window.addEventListener('beforeunload', function () {
        console.log('🔥 beforeunload triggered');
        if (!formSubmitted && window.loggedInCustomerEmail) {
          console.log('✅ Pre-checkout abandonment detected');
          console.log('📧 Email:', window.loggedInCustomerEmail);
      
          const payload = { /* ... */ };
          console.log('📤 Sending payload:', payload);
      
          const encoded = btoa(JSON.stringify(payload));
          const url = "https://a.klaviyo.com/api/track?data=" + encoded;
          console.log('🔗 Beacon URL:', url);
      
          navigator.sendBeacon(url);
          console.log('🚀 Beacon sent');
        } else {
          console.log('🚫 No abandonment event sent');
          if (!window.loggedInCustomerEmail) console.log('❌ No logged-in email');
          if (formSubmitted) console.log('✅ Form was submitted');
        }
      });
    });
  })();
</script>